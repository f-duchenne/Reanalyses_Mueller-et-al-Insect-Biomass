
#' 
#' **Weather explains variability in insect biomass, but not its temporal decline**
#'
#' François Duchenne
#' Based on the code provided by 
#' Jörg Müller, Torsten Hothorn, Ye Yuan, Sebastian Seibold, Oliver Mitesser, Julia Rothacher, 
#' Julia Freund, Clara Wild, Marina Wolz, Annette Menzel (revised and resubmitted, 2023)
#'
#' This document reproduces tables and figures.
#'

#'
#' Check for packages and if necessary install into library 
#+ message = FALSE
rm(list=ls())
pkgs <- c("mgcv", "knitr", "multcomp", "coin", "colorspace", "ggplot2", 
          "data.table", "tidyverse", "vegan","sf","gridExtra","scales",
		  "ggeffects","ggforce","raster","viridis","ggnewscale","ggdensity") 

inst <- pkgs %in% installed.packages()
if (any(inst)) install.packages(pkgs[!inst])
pkg_out <- lapply(pkgs, require, character.only = TRUE)
#' Results were obtained in this environment
date()
sessionInfo()

#' Set working directory
setwd(dir="C:/Users/Duchenne/Documents/Mueller et al Insect Biomass data and R code")
#' The HTML output file was generated by
#library("knitr")
#spin("analysis.R")

#' Estimation method for mgcv::gam(),
#' see https://github.com/DistanceDevelopment/dsm/wiki/Why-is-the-default-smoothing-method-%22REML%22-rather-than-%22GCV.Cp%22%3F
#'
#' Results were compared with both options, results differed marginally
METHOD <- "REML"  ### or "GCV.Cp"
#'

#' Reading all data including published data by Hallmann et al. (2017) PLoS One 12: e0185809 until 2016 (data_org) 
#' and new data collected by our own in 2016, 2019, 2020, 2022 (validation)
data_org <-read.csv2("Data_Update_Revision_spells.csv", header = TRUE)

#' Setup factor coding for year (for plots only)
yr <- as.character(data_org$year)
t16 <- which(yr == "2016" & data_org$dataset == "training")
yr[t16] <- "2016t"
v16 <- which(yr == "2016" & data_org$dataset == "validation")
yr[v16] <- "2016v"
lev <- c(1989:2015, "2016t", "2016v", 2017:2022)
data_org$fyear <- factor(yr, levels = lev, labels = lev)



coords=vector(unique(data_org[,c("plot","E","N")]),crs=4326)

cor2018=rast("D:/land use change/corine_raster_100m_europe/U2018_CLC2018_V2020_20u1.tif")